#:kivy 2.0.0

# ----- STYLING CONSTANTS -----

# Color definitions (RGBA values)

#:set PRIMARY_COLOR [0.12, 0.45, 0.82, 1]
#:set SECONDARY_COLOR [0.3, 0.3, 0.3, 1]
#:set ACCENT_COLOR [0.9, 0.5, 0.1, 1]
#:set BACKGROUND_COLOR [0.95, 0.95, 0.95, 1]
#:set TEXT_COLOR [0.9, 0.9, 0.9, 1]
#:set SUCCESS_COLOR [0.2, 0.7, 0.3, 1]

# Font sizes

#:set FONT_LARGE 24
#:set FONT_MEDIUM 18
#:set FONT_NORMAL 16
#:set FONT_SMALL 14

# Dimensions

#:set MENU_HEIGHT 50
#:set BUTTON_HEIGHT 60
#:set TABLE_ROW_HEIGHT 60
#:set HEADER_HEIGHT 40
#:set MENU_BUTTON_WIDTH 100
#:set NAV_BUTTON_WIDTH 200

# Spacing values

#:set SPACING_LARGE 20
#:set SPACING_MEDIUM 10
#:set SPACING_SMALL 5
#:set PADDING_LARGE 50
#:set PADDING_MEDIUM 20
#:set PADDING_SMALL 10
#:set PADDING_XLARGE 70 

# ----- COMPONENTS -----

<MenuButton@Button>:
    background_color: PRIMARY_COLOR
    font_size: FONT_SMALL
    size_hint_x: None
    width: MENU_BUTTON_WIDTH

<HelpIconButton>:
    orientation: 'vertical'
    spacing: dp(2) 
    padding: dp(5)
    background_color: [0,0,0,0] 
    
    Image:
        source: root.source
        size_hint_y: 0.7 
        pos_hint: {'center_x': 0.5} 
        fit_mode: 'contain' 
    Label:
        text: root.label_text
        font_size: FONT_SMALL
        color: [1,1,1,1]
        halign: 'center'
        valign: 'middle'
        size_hint_y: 0.3 
        text_size: self.size

<PrimaryButton>:
    background_color: PRIMARY_COLOR
    font_size: FONT_MEDIUM
    size_hint_y: None
    height: BUTTON_HEIGHT
    color: [1,1,1,1] 
    background_normal: '' 
    background_down: '' 
    canvas.before:
        Color:
            rgba: self.background_color if self.state == 'normal' else [x*0.8 for x in self.background_color[:3]] + [1]
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(5),] 

<SecondaryButton@Button>:
    background_color: SECONDARY_COLOR
    font_size: FONT_MEDIUM
    size_hint_y: None
    height: BUTTON_HEIGHT

<NavButton@Button>:
    background_color: SECONDARY_COLOR
    font_size: FONT_NORMAL
    size_hint_x: None
    width: NAV_BUTTON_WIDTH
    size_hint_y: None
    height: BUTTON_HEIGHT

<ConnectButton@Button>:
    background_color: SUCCESS_COLOR
    font_size: FONT_NORMAL
    size_hint_y: None
    height: TABLE_ROW_HEIGHT

<TitleLabel@Label>:
    font_size: FONT_LARGE
    color: TEXT_COLOR
    text_size: self.size
    halign: 'left'

<NormalLabel@Label>:
    font_size: FONT_NORMAL
    color: [0.2,0.2,0.2,1]
    text_size: self.size
    halign: 'left'

<HeaderLabel@Label>:
    font_size: FONT_NORMAL
    bold: True
    color: TEXT_COLOR
    size_hint_y: None
    height: HEADER_HEIGHT
    text_size: self.size
    halign: 'left'

<WiFiLabel@Label>:
    font_size: FONT_SMALL
    color: TEXT_COLOR
    halign: 'left'
    valign: 'middle'
    size_hint_y: None
    height: TABLE_ROW_HEIGHT
    text_size: self.size

<ScreenLayout@BoxLayout>:
    orientation: 'vertical'
    spacing: SPACING_LARGE
    padding: PADDING_LARGE

<CompactLayout@BoxLayout>:
    orientation: 'vertical'
    spacing: SPACING_MEDIUM
    padding: PADDING_MEDIUM

<HorizontalLayout@BoxLayout>:
    orientation: 'horizontal'
    spacing: SPACING_MEDIUM

<VerticalLayout@BoxLayout>:
    orientation: 'vertical'

<TableLayout@GridLayout>:
    cols: 2
    spacing: SPACING_SMALL
    size_hint_y: None

<TopMenuBar>:
    orientation: 'horizontal'
    size_hint_y: None
    height: MENU_HEIGHT
    spacing: SPACING_MEDIUM
    padding: PADDING_SMALL, SPACING_SMALL, PADDING_SMALL, SPACING_SMALL

<WiFiNetworkItem@BoxLayout>:
    orientation: 'vertical'
    padding: PADDING_MEDIUM
    spacing: SPACING_MEDIUM
    size_hint_y: None
    height: self.minimum_height
    canvas.before:
        Color: 
            rgba: SECONDARY_COLOR 
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(5),]
    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: None
        height: dp(30)
        WiFiLabel:
            text: root.ssid 
            font_size: FONT_MEDIUM
            bold: True
            size_hint_x: 0.7
            halign: 'left'
            valign: 'middle'
        WiFiLabel: 
            text: f'({root.signal} dBm)' 
            halign: 'right'
            size_hint_x: 0.3
            color: [0.7, 0.7, 0.7, 1]
            valign: 'middle'
            font_size: FONT_SMALL
    WiFiLabel:
        text: f'Seguran√ßa: {root.security_type}' 
        color: [0.8, 0.8, 0.8, 1]
        size_hint_y: None
        height: dp(25)
        halign: 'left' 
        valign: 'middle'
        font_size: FONT_SMALL
    ConnectButton:
        text: 'Connect'
        on_press: root.connect_action()
        size_hint_y: None
        height: dp(40)

<ConnectionScreen>:
    FloatLayout: 
        CompactLayout:
            id: main_content
            size_hint: 0.8, 0.8
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            HorizontalLayout:
                size_hint_y: None
                height: dp(60)
                TitleLabel:
                    text: 'WiFi Connections'
                    font_size: FONT_MEDIUM
                    color: SECONDARY_COLOR
                SecondaryButton:
                    text: 'Back to main'
                    on_press: root.emit_navigate_back()
            ScrollView:
                id: scroll_view_for_table
                bar_width: dp(10)
                do_scroll_x: False
                BoxLayout:
                    id: network_list_container 
                    orientation: 'vertical'
                    spacing: SPACING_MEDIUM
                    padding: PADDING_MEDIUM
                    size_hint_y: None
                    height: self.minimum_height

<SystemImageItem>:
    font_size: FONT_NORMAL
    halign: 'left'
    valign: 'middle'
    padding: PADDING_SMALL
    canvas.before:
        Color:
            rgba: SECONDARY_COLOR if self.state == 'normal' else PRIMARY_COLOR 
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(5),]
    
    BoxLayout:
        orientation: 'horizontal'
        padding: dp(5)
        
        Label: 
            text: root.image_name
            font_size: FONT_NORMAL
            color: TEXT_COLOR
            halign: 'left'
            valign: 'middle'
            text_size: self.size
            size_hint_x: 0.7 

        Label: 
            text: 'Compatible' if root.is_compatible else 'Imcompatible'
            font_size: FONT_SMALL
            color: SUCCESS_COLOR if root.is_compatible else ACCENT_COLOR
            halign: 'right'
            valign: 'middle'
            text_size: self.size
            size_hint_x: 0.3 

<PostConnectionScreen>:
    FloatLayout:
        id: main_content
        size_hint: 0.9, 0.9
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        
        
        CompactLayout:
            orientation: 'vertical'
            spacing: SPACING_MEDIUM
            padding: PADDING_MEDIUM

            HorizontalLayout: 
                size_hint_y: None
                height: dp(60)
                TitleLabel:
                    text: 'BC Module Connected'
                    font_size: FONT_MEDIUM
                    color: PRIMARY_COLOR
                SecondaryButton: 
                    text: 'Logout'
                    on_press: root.emit_logout_event()

            HorizontalLayout: 
                size_hint_y: None
                height: dp(40)
                NormalLabel:
                    text: f'Hardware PN: {root.hardware_pn}'
                    halign: 'left'

            NormalLabel:
                text: 'System Image Compatible:'
                size_hint_y: None
                height: dp(30)
                halign: 'left'

            ScrollView: 
                bar_width: dp(10)
                do_scroll_x: False
                BoxLayout:
                    id: image_list_container 
                    orientation: 'vertical'
                    spacing: SPACING_SMALL
                    size_hint_y: None
                    height: self.minimum_height

            BoxLayout: 
                orientation: 'horizontal'
                size_hint_y: None
                height: dp(60)
                spacing: SPACING_MEDIUM

                PrimaryButton:
                    text: 'Load selected image'
                    on_press: root.load_selected_image()
                    disabled: not root.selected_image_item or not root.selected_image_item.is_compatible

                SecondaryButton:
                    text: 'Disconnect BC Module'
                    on_press: root.request_disconnect_confirmation()

<LoginCard>:
    orientation: 'vertical'
    spacing: SPACING_MEDIUM 
    padding: PADDING_MEDIUM, PADDING_MEDIUM, PADDING_MEDIUM, PADDING_MEDIUM
    minimum_width: dp(400)
    # minimum_height: dp(500)
    
    canvas.before:
        Color:
            rgba: [1, 1, 1, 1] 
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(15),]

<LoginTextInput>:
    multiline: False
    font_size: FONT_MEDIUM
    size_hint_y: None
    height: dp(50) 
    padding: dp(5), dp(5)
    background_color: [1, 1, 1, 0] 
    foreground_color: [0.2, 0.2, 0.2, 1] 
    hint_text_color: [0.4, 0.4, 0.4, 1] 
    write_tab: False
    cursor_color: (1, 0, 0, 1)
    cursor_width: dp(2) 
    cursor_blink: True 
    
    canvas.before:
        Color:
            rgba: ([0.95, 0.95, 0.95, 1] if self.focus else [1, 1, 1, 1])
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(5),]
            
        Color:
            rgba: ([0.4, 0.4, 0.4, 1] if self.focus else [0.6, 0.6, 0.6, 1]) 
        Line:
            width: (dp(1.5) if self.focus else dp(1)) 
            rounded_rectangle: (self.x, self.y, self.width, self.height, dp(5))

<LoginScreen>:
    FloatLayout: 
        Image:
            source: './uploads/background_image.png'
            allow_stretch: True
            keep_ratio: False
            size_hint: (1, 1)
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}

        LoginCard:
            size_hint: (0.4, 0.6)
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            padding: PADDING_SMALL
            
            BoxLayout:
                orientation: 'vertical'
                spacing: SPACING_LARGE
                padding: PADDING_MEDIUM, PADDING_MEDIUM, PADDING_MEDIUM, PADDING_MEDIUM
                
                BoxLayout:
                    size_hint_y: 0.30 
                    padding: SPACING_MEDIUM, SPACING_MEDIUM 

                    Image:
                        source: './uploads/EMB_Logo_RGB_1.png'
                        size_hint: (1, 1)
                        pos_hint: {'center_x': 0.5, 'center_y': 0.5} 
                        fit_mode: 'contain'
                
                LoginTextInput:
                    id: username_input 
                    hint_text: 'Username'
                    on_text_validate: root.focus_password_input(self) 
                    size_hint_y: 0.15 
                    
                LoginTextInput:
                    id: password_input 
                    hint_text: 'Password'
                    password: True
                    on_text_validate: root.attempt_login(root.username_input.text, self.text)
                    size_hint_y: 0.15 

                NormalLabel:
                    text: root.login_message
                    color: [0.9, 0.2, 0.2, 1]
                    size_hint_y: 0.10 
                    halign: 'center'
                    valign: 'middle'
                    text_size: self.size[0] * 0.9, None

                PrimaryButton:
                    text: 'Login'
                    size_hint_y: 0.20 
                    # Removida: height: min(self.height, dp(50))
                    on_release: root.attempt_login(root.username_input.text, root.password_input.text)